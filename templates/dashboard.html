<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Mining Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
        }
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-danger { background-color: #dc3545; }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .analysis-section {
            display: none;
        }
        .activity-badge {
            display: inline-block;
            margin: 5px;
            padding: 8px 15px;
            background: linear-gradient(45deg, #007bff, #6c757d);
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .activity-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .activity-flow {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        .activity-arrow {
            color: #6c757d;
            font-size: 1.2rem;
            margin: 0 5px;
        }
        .process-timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 15px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 5px;
        }
        .timeline-item:before {
            content: '‚óè';
            position: absolute;
            left: -8px;
            top: 15px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">üîç Process Mining Dashboard</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alert Section -->
        <div id="alertSection"></div>

        <!-- Control Panel -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Analysis Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button id="analyzeExistingBtn" class="btn btn-primary btn-lg w-100 mb-3">
                                    üöÄ Analyze Insurance Claims Data
                                </button>
                                <button id="debugBtn" class="btn btn-outline-info w-100 mb-2">
                                    üîç Debug Analysis
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fileUpload" class="form-label">Or Upload Your Own File:</label>
                                    <input type="file" class="form-control" id="fileUpload" accept=".xlsx,.csv">
                                </div>
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <input type="text" class="form-control" id="caseCol" placeholder="Case Column" value="case_id">
                                    </div>
                                    <div class="col-4">
                                        <input type="text" class="form-control" id="activityCol" placeholder="Activity Column" value="activity_name">
                                    </div>
                                    <div class="col-4">
                                        <input type="text" class="form-control" id="timestampCol" placeholder="Timestamp Column" value="timestamp">
                                    </div>
                                </div>
                                <button id="uploadBtn" class="btn btn-secondary w-100" disabled>üìÅ Upload & Analyze</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Analyzing process data... This may take a few moments.</p>
        </div>

        <!-- Statistics Section -->
        <div id="statisticsSection" class="analysis-section">
            <div class="row">
                <div class="col-md-2">
                    <div class="card metric-card">
                        <div class="metric-value" id="casesCount">-</div>
                        <div class="metric-label">Cases</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card metric-card">
                        <div class="metric-value" id="eventsCount">-</div>
                        <div class="metric-label">Events</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card metric-card">
                        <div class="metric-value" id="fitnessScore">-</div>
                        <div class="metric-label">Fitness</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card metric-card">
                        <div class="metric-value" id="precisionScore">-</div>
                        <div class="metric-label">Precision</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card metric-card">
                        <div class="metric-value" id="bottlenecksCount">-</div>
                        <div class="metric-label">Bottlenecks</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card metric-card">
                        <button id="downloadBtn" class="btn btn-success btn-sm">üì• Download CSV</button>
                        <div class="metric-label mt-1">Optimized Data</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Process Flow Graph -->
        <div id="processGraphSection" class="analysis-section">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üîÑ Process Flow Visualization</h5>
                        </div>
                        <div class="card-body">
                            <div id="processGraph" style="height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottlenecks Section -->
        <div id="bottlenecksSection" class="analysis-section">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üê¢ Detected Bottlenecks</h5>
                        </div>
                        <div class="card-body">
                            <div id="bottlenecksList">
                                <p class="text-muted">No bottlenecks detected or analysis not completed.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activities List -->
        <div id="activitiesSection" class="analysis-section">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìã Process Activities</h5>
                        </div>
                        <div class="card-body">
                            <div id="activitiesList">
                                <p class="text-muted">No activities loaded.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6>üîç Activity Statistics</h6>
                        </div>
                        <div class="card-body">
                            <div id="activityStats">
                                <p class="text-muted">No statistics available.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let analysisComplete = false;

        // Show alert function
        function showAlert(message, type = 'info') {
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#alertSection').html(alertHTML);
        }

        // Load statistics
        function loadStatistics() {
            $.get('/get_statistics')
                .done(function(data) {
                    if (data.error) {
                        console.error('Error loading statistics:', data.error);
                        return;
                    }
                    
                    $('#casesCount').text(data.cases_count || 0);
                    $('#eventsCount').text(data.events_count || 0);
                    $('#fitnessScore').text(data.fitness || '0.0000');
                    $('#precisionScore').text(data.precision || '0.0000');
                    $('#bottlenecksCount').text(data.bottlenecks_count || 0);
                    
                    // Load activities
                    if (data.activities && data.activities.length > 0) {
                        // Create timeline view
                        const timelineHTML = data.activities.map((activity, index) => `
                            <div class="timeline-item">
                                <strong>Step ${index + 1}:</strong> ${activity}
                            </div>
                        `).join('');
                        
                        // Create flow view
                        const flowHTML = data.activities.map((activity, index) => {
                            const arrow = index < data.activities.length - 1 ? '<span class="activity-arrow">‚Üí</span>' : '';
                            return `<span class="activity-badge">${activity}</span>${arrow}`;
                        }).join('');
                        
                        const activitiesHTML = `
                            <div class="mb-4">
                                <h6 class="mb-3">üîÑ Process Flow:</h6>
                                <div class="activity-flow">
                                    ${flowHTML}
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-3">üìã Process Timeline:</h6>
                                <div class="process-timeline">
                                    ${timelineHTML}
                                </div>
                            </div>
                        `;
                        
                        $('#activitiesList').html(activitiesHTML);
                        
                        // Add activity statistics
                        const statsHTML = `
                            <div class="mb-3">
                                <strong>Total Activities:</strong><br>
                                <span class="text-primary fs-4">${data.activities.length}</span>
                            </div>
                            <div class="mb-3">
                                <strong>Process Complexity:</strong><br>
                                <span class="badge ${data.activities.length > 10 ? 'bg-warning' : data.activities.length > 5 ? 'bg-info' : 'bg-success'}">
                                    ${data.activities.length > 10 ? 'High' : data.activities.length > 5 ? 'Medium' : 'Low'}
                                </span>
                            </div>
                            <div class="mb-3">
                                <strong>Key Activities:</strong><br>
                                <small class="text-muted">
                                    ${data.activities.slice(0, 3).join(', ')}
                                    ${data.activities.length > 3 ? '...' : ''}
                                </small>
                            </div>
                        `;
                        $('#activityStats').html(statsHTML);
                    }
                })
                .fail(function() {
                    console.error('Failed to load statistics');
                });
        }

        // Load bottlenecks
        function loadBottlenecks() {
            $.get('/get_bottlenecks')
                .done(function(data) {
                    if (data.error) {
                        console.error('Error loading bottlenecks:', data.error);
                        return;
                    }
                    
                    if (data.length === 0) {
                        $('#bottlenecksList').html('<p class="text-success">‚úÖ No significant bottlenecks detected!</p>');
                    } else {
                        const bottlenecksHTML = data.map(bottleneck => `
                            <div class="alert alert-warning mb-2">
                                <strong>${bottleneck.source}</strong> ‚Üí <strong>${bottleneck.target}</strong>
                                <span class="float-end">${bottleneck.duration_hours} hours</span>
                            </div>
                        `).join('');
                        $('#bottlenecksList').html(bottlenecksHTML);
                    }
                })
                .fail(function() {
                    console.error('Failed to load bottlenecks');
                });
        }

        // Load process graph
        function loadProcessGraph() {
            console.log('Loading process graph...');
            $.get('/get_process_graph')
                .done(function(data) {
                    console.log('Process graph response:', data);
                    
                    if (data.error) {
                        console.error('Error loading process graph:', data.error);
                        $('#processGraph').html(`
                            <div class="alert alert-warning">
                                <h6>‚ö†Ô∏è Process Graph Not Available</h6>
                                <p>${data.error}</p>
                                <small>This might happen if the analysis is still processing or if there's insufficient data.</small>
                            </div>
                        `);
                        return;
                    }
                    
                    if (!data.data || data.data.length === 0) {
                        $('#processGraph').html(`
                            <div class="alert alert-info">
                                <h6>üìä No Process Flow Data</h6>
                                <p>No process flow relationships found in the data.</p>
                            </div>
                        `);
                        return;
                    }
                    
                    try {
                        Plotly.newPlot('processGraph', data.data, data.layout, {
                            responsive: true,
                            displayModeBar: true,
                            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                        });
                    } catch (plotError) {
                        console.error('Plotly error:', plotError);
                        $('#processGraph').html(`
                            <div class="alert alert-danger">
                                <h6>‚ùå Graph Rendering Error</h6>
                                <p>Failed to render the process graph. Please try refreshing the analysis.</p>
                            </div>
                        `);
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Failed to load process graph. Status:', status, 'Error:', error);
                    $('#processGraph').html(`
                        <div class="alert alert-danger">
                            <h6>‚ùå Connection Error</h6>
                            <p>Failed to load process graph data from the server.</p>
                            <small>Status: ${status}, Error: ${error}</small>
                        </div>
                    `);
                });
        }

        // Show analysis results
        function showAnalysisResults() {
            $('.analysis-section').show();
            loadStatistics();
            loadBottlenecks();
            loadProcessGraph();
        }

        // Analyze existing data
        $('#analyzeExistingBtn').click(function() {
            $('#loadingSection').show();
            $('.analysis-section').hide();
            
            $.get('/analyze_existing')
                .done(function(data) {
                    $('#loadingSection').hide();
                    
                    if (data.status === 'success') {
                        showAlert('‚úÖ Analysis completed successfully!', 'success');
                        analysisComplete = true;
                        showAnalysisResults();
                    } else {
                        showAlert('‚ùå Analysis failed: ' + data.message, 'danger');
                    }
                })
                .fail(function() {
                    $('#loadingSection').hide();
                    showAlert('‚ùå Failed to connect to analysis service', 'danger');
                });
        });

        // File upload handling
        $('#fileUpload').change(function() {
            const file = this.files[0];
            $('#uploadBtn').prop('disabled', !file);
        });

        // Upload and analyze
        $('#uploadBtn').click(function() {
            const formData = new FormData();
            const file = $('#fileUpload')[0].files[0];
            
            if (!file) {
                showAlert('Please select a file first', 'warning');
                return;
            }
            
            formData.append('file', file);
            formData.append('case_col', $('#caseCol').val());
            formData.append('activity_col', $('#activityCol').val());
            formData.append('timestamp_col', $('#timestampCol').val());
            
            $('#loadingSection').show();
            $('.analysis-section').hide();
            
            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    $('#loadingSection').hide();
                    
                    if (data.status === 'success') {
                        showAlert('‚úÖ File uploaded and analyzed successfully!', 'success');
                        analysisComplete = true;
                        showAnalysisResults();
                    } else {
                        showAlert('‚ùå Upload failed: ' + data.message, 'danger');
                    }
                },
                error: function() {
                    $('#loadingSection').hide();
                    showAlert('‚ùå Failed to upload file', 'danger');
                }
            });
        });

        // Debug analysis
        $('#debugBtn').click(function() {
            $.get('/debug_analysis')
                .done(function(data) {
                    console.log('Debug info:', data);
                    const debugHTML = `
                        <div class="alert alert-info">
                            <h6>üîç Debug Information</h6>
                            <ul>
                                <li>Analysis results exist: ${data.analysis_results_exists}</li>
                                <li>Analysis keys: ${data.analysis_keys.join(', ')}</li>
                                <li>Performance DFG exists: ${data.perf_dfg_exists}</li>
                                <li>Performance DFG length: ${data.perf_dfg_length}</li>
                                <li>Sample data: <pre>${JSON.stringify(data.sample_perf_dfg, null, 2)}</pre></li>
                            </ul>
                        </div>
                    `;
                    showAlert(debugHTML, 'info');
                })
                .fail(function() {
                    showAlert('Failed to get debug information', 'danger');
                });
        });

        // Download optimized data
        $('#downloadBtn').click(function() {
            if (!analysisComplete) {
                showAlert('Please complete analysis first', 'warning');
                return;
            }
            
            window.location.href = '/download_optimized';
        });

        // Initial page load
        $(document).ready(function() {
            showAlert('Welcome to the Process Mining Dashboard! Click "Analyze Insurance Claims Data" to start.', 'info');
        });
    </script>
</body>
</html>
